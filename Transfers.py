import usb, time, random, sys, dfu



HOST2DEVICE = 0x21

DFU_DETACH = 0
DFU_DNLOAD = 1
DFU_UPLOAD = 2
DFU_GETSTATUS = 3
DFU_CLRSTATUS = 4
DFU_GETSTATE = 5
DFU_ABORT = 6


def controlTransfer(device, bmRequestType, bRequest, wValue, wIndex, data_or_wLength, timeout):
    try:
        device.ctrl_transfer(bmRequestType, bRequest, wValue, wIndex, data_or_wLength, timeout)
        return 0
    except usb.core.USBError as e:
        print("Control transfer ERROR: %d, %d, %r" % (bmRequestType, bRequest, e))
        if "No such device" in str(e):
            print("Device disconnected, possible a reboot?")
        return 1


device = dfu.acquire_device()
print("Got device")
controlTransfer(device, HOST2DEVICE, DFU_DNLOAD, 0, 0, 0x40, 5)
print("Send initial transfer")
controlTransfer(device, 235, 0, 0, 0, b'\xc5\x84\x80\x0e\n\xbc_\x87\xc0\x0cQ\xe0\xbe\xd32\xc9\x96\x98\x93o\xe4\x1d\xf0\xb0)}^\x04f<0A\xf7\x9a\x81q\xe9.\xe6\xec\x03\xa8\t\xd8@\xb1\x86\x88\xe7\xd70\x7fve#L\x19\x99\xbcIj\xbe\xc9\xf5GW\xb9\x92\x83\xc8\x8e\x06N\xff\x1e\xff~\xbcc\xa3\xb1\xdbE\r^\x13\x8fu\x04\xbelk\xb4&\xc0M\xff\x1aQ\xe9\x8fm\x16l\xa2l\x96\xe8j\xd5\xb5\x18\xf3\xd8n\xf9%H]3\x07\x8f\x85\x1d\x00\xc2\xdah\x04\xa4\xef\x94\xd9x<p\xfc8\x92\xa5\x9br\x93\x12w\xber8\xc8\x84*a~`\x07\x10\xdbbe\xe7g\x17\x06\xbf;\xaa\xfc\xe1r }K-(\x00a\xb8>]\xc9\x0fY\xe6O\x9f\x93B\x05\xfe\x9c\x7f\xf7u\xc7Tf\x94\xb6j\xfd\x9c$.\xdf\xd8D\xc9g3}\xcb!\xcd)A\x93x\xd9[$\x87\xc9\x92\x99\xfd\x95"\x8e{\xef\xa3\xe2\xae\xab\xf7n\x05+\x02\xf4G\x08\xf8x7\xe0\x1bk\xa7t;\xba\\\xafn\xaaw\x9c\xde\xd4.r\xf5\xdc\x0ek\xffG]FO;\x9f\xb6{5X\xb6\r\xf0\xf6^\xfd\xb75;;\x05<r\xfb\x1c}\x01r\xc4ow\x0b}\xd2\xe6\x8d\x03}\x85\x16W\x8d\xbd\xc4J\x83\x87\xd8\xc6\xa7\xb8t^b\xa0\xbe\x86\x9b"c\xb1\xd2\x08\x8c\x10\xcd6\x1e\x04\xa8\xa2O\x01\x13\xfb\xea\xc9\xc3\xc7\xc3\x02\xc9\xfb\x92\xca\xfa(\xae\xc3;\xb7\xd8t\xe3\xa1\r\xf0z)-\xe5I\x085\xf4*oG\xf6m\xd0\xb1\xa9\xf5p\x95b\xafx\xf5\x14\xa2>\xd6\xdbW?\xf4K\xbay\x99\xc6\xde\x1e\xbew\x84\x97]py\x03\x89\xcc*\x1dt\xed\xbf\x94\xd8\xff+\x81\x98\x16s\x04r\xf6\x94\xb4\x89\xd8\x96\xd79\x0b\x86y5\x05\xd15|&\xd6\xe8\x89\x84\xaa\xc0\xa1\xa5I\xe9d\x9b\'\xe8\xb0\x92\xe2~\xa9\xb4\xd0\x0foTe\xc4\x1a\xde\x1d\x19\xad\n\xac\x8d\x14\x9cE\xfc\xa8\x97\x07\xe3\xfe\x10\x81\x9am\xeeL\xddX\x07\x8c\x87\xeb\xb2\x85\xb6\x99\xdf\x05\x81\x1b\xdb\x90\xce\xa3\xe7",\xb8G\x9b\xe3r\xf2@\x9e\xf4\xe1\x8b]*\xb3nY\x1f\xfc\xc2$CE~\xf4\x01>\xd4\x9dy\x0f\xf7\xf6{\xf0\xe3>\x8ep\xe76K\x9d\x05\xa7U6\x19\xc7\xbc\x96`CU\xf2\xfc\x80\xf1o\x9c\x17\x97\xd9v[\x1c\xeeU`\x1b\xfc\xc0\xc5\xa4\'R\xbc?\x00\xdc\xbc\xe6\xe8\x98\xc6\xf2\x10c\x15\x14\x05\x0b\xb5\xaa\xb6\xfd\xbb\xcc!\x90E:\xa5\xf4\x1b1utd>\xc5\x03\x00\xa6\x18\xdb\xfa%\xadY+\xab\x14N\r\xf9\xd2\xee\xaeg\xef\x13\x01\x11)f\xf8\xa9\xbe\x98\x94\xe9\x80d=\xf0$\xc5\x99\x89\x97\'#\x9fX\x9d\xce]\x05\xdf\xce\xca\xcd\xbb\x95\xb6\xfe\xd0\xbb1\xfc\xdf[;T\xf4+\xa7\xcc\xbb\xab\xe0n\x9cD\x83\n\xd3\\\xc9\xde\xc1s\xa8\xfe\xd3\x016\x1a\x9c\xcd\xdcX|\xffd\x00\xbb\x9c\x06e{\xbdR\xefXK\xd1|\xc0\xa4\x97\xcaa\xe1\x7f\\\xa2\xa3\'sxA\x99\x92\xb6\x9e\xec\xd1h\x8f\x19\xd2\xda\xdb,\xf5\x1b\xe2\xb3m\x8a\xdb\x03\xa6\x8b\x82\'EMLIm-w\xcc#\xa86J2]\xd9(h\xbc\x0b\xc7\x93\x99[\xe4\xad\xdb\xa4\x0eI(\x11wL\xd6\xc7\x0f\x12\x0bfBWP\xa9\xeb\xf6 b\x96!o0t,\xa7\x96c9kR[\x1b(\x1f"\x16y\n\xe2ek\xfd\xb2\x88\x19\xb0\xe1\x07j\xeb\xeb\x12\xd1]\xe0\xbdA38\xb6!\x8fJn', 5)
print("Crash?")
controlTransfer(device, HOST2DEVICE, 0, 0, 0, 0, 5)